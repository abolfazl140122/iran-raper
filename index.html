
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Iran Rap - Loading...</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lalezar&family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css">
</head>
<body>
  <div class="background-animation"></div>

  <div id="loading-screen">
    <img src="https://up.20script.ir/file/4376-Copilot-20250812-110015-removebg-preview-2-.png" alt="Studio Logo" id="logo">
    <h1 id="game-title">Iran Rap</h1>
    <div id="loader-container">
      <div id="progress-bar"></div>
    </div>
    <p id="status-text">در حال بارگذاری...</p>
  </div>
  
  <div id="main-content" class="hidden">
    <!-- Main Menu -->
    <div id="main-menu">
        <h1 class="menu-title">Iran Rap</h1>
        
        <div id="name-entry-container">
          <input type="text" id="player-name-input" class="menu-input" placeholder="نام خود را وارد کنید..." aria-label="Player Name"/>
          <button id="continue-btn" class="menu-button">ادامه</button>
        </div>
    
        <div id="welcome-container" class="hidden">
            <h2 id="welcome-message"></h2>
            <button id="change-name-btn" class="link-button">تغییر نام</button>
        </div>
    
        <div id="main-menu-buttons" class="hidden">
          <button id="start-game-btn" class="menu-button">شروع بازی</button>
          <button id="settings-btn" class="menu-button">تنظیمات</button>
        </div>
    </div>

    <!-- Chapter Selection -->
    <div id="chapter-select-screen" class="hidden">
        <h2 class="menu-title" id="chapter-select-title">فصل‌ها را انتخاب کنید</h2>
        <div id="chapter-grid">
            <div class="chapter-card" data-chapter="1" data-title="یاس" data-source="yas.json" data-total-levels="200">فصل ۱</div>
            <div class="chapter-card disabled" data-chapter="2" data-title="پیشرو" data-source="pishro.json" data-total-levels="6">
              فصل ۲
              <span class="soon-text">ابتدا فصل ۱ را کامل کنید</span>
            </div>
            <div class="chapter-card disabled" data-chapter="3">
              فصل ۳
              <span class="soon-text">به زودی</span>
            </div>
        </div>
        <button id="back-to-main-btn" class="menu-button secondary">بازگشت</button>
    </div>

    <!-- Level Selection -->
    <div id="level-select-screen" class="hidden">
        <h2 class="menu-title" id="level-select-title">یاس</h2>
        <div id="level-grid-container">
          <div id="level-grid"></div>
        </div>
        <button id="back-to-chapters-btn" class="menu-button secondary">بازگشت به فصل‌ها</button>
    </div>

    <!-- Game Screen -->
    <div id="game-screen" class="hidden">
      <div id="question-title-container">
        <h2 class="menu-title" id="question-title"></h2>
      </div>
      <div id="timer-bar-container">
        <div id="timer-bar-progress"></div>
      </div>
      <p id="question-text"></p>
      <div id="answers-container"></div>
      <button id="back-to-map-ingame-btn" class="menu-button secondary">بازگشت به نقشه راه</button>
    </div>

  </div>

  <!-- Feedback Modal -->
  <div id="feedback-modal" class="hidden">
      <div class="modal-content">
          <h2 id="modal-title"></h2>
          <p id="modal-message"></p>
          <div id="modal-actions">
              <button id="modal-next-btn" class="menu-button">مرحله بعد</button>
              <button id="modal-retry-btn" class="menu-button">تلاش مجدد</button>
              <button id="modal-map-btn" class="menu-button secondary">بازگشت به نقشه</button>
          </div>
      </div>
  </div>


  <script>
    /**
     * @license
     * Copyright 2025 Google LLC
     * SPDX-License-Identifier: Apache-2.0
     */

    document.addEventListener('DOMContentLoaded', async () => {
      // --- Constants ---
      const LEVEL_TIME = 20; // seconds

      // --- Element Cache ---
      const loadingScreen = document.getElementById('loading-screen');
      const progressBar = document.getElementById('progress-bar');
      const statusText = document.getElementById('status-text');
      const loaderContainer = document.getElementById('loader-container');
      const backgroundAnimation = document.querySelector('.background-animation');
      
      const mainContent = document.getElementById('main-content');
      const screens = {
        mainMenu: document.getElementById('main-menu'),
        chapterSelect: document.getElementById('chapter-select-screen'),
        levelSelect: document.getElementById('level-select-screen'),
        game: document.getElementById('game-screen'),
      };

      const nameEntryContainer = document.getElementById('name-entry-container');
      const playerNameInput = document.getElementById('player-name-input');
      const continueBtn = document.getElementById('continue-btn');
      const welcomeContainer = document.getElementById('welcome-container');
      const welcomeMessage = document.getElementById('welcome-message');
      const mainMenuButtons = document.getElementById('main-menu-buttons');
      const changeNameBtn = document.getElementById('change-name-btn');

      const startGameBtn = document.getElementById('start-game-btn');
      const settingsBtn = document.getElementById('settings-btn');
      const backToMainBtn = document.getElementById('back-to-main-btn');
      const chapterGrid = document.getElementById('chapter-grid');

      const levelSelectTitle = document.getElementById('level-select-title');
      const levelGrid = document.getElementById('level-grid');
      const backToChaptersBtn = document.getElementById('back-to-chapters-btn');

      const gameScreen = document.getElementById('game-screen');
      const timerBarProgress = document.getElementById('timer-bar-progress');
      const questionTitle = document.getElementById('question-title');
      const questionText = document.getElementById('question-text');
      const answersContainer = document.getElementById('answers-container');
      const backToMapInGameBtn = document.getElementById('back-to-map-ingame-btn');


      const feedbackModal = document.getElementById('feedback-modal');
      const modalTitle = document.getElementById('modal-title');
      const modalMessage = document.getElementById('modal-message');
      const modalNextBtn = document.getElementById('modal-next-btn');
      const modalRetryBtn = document.getElementById('modal-retry-btn');
      const modalMapBtn = document.getElementById('modal-map-btn');


      // --- Element Check ---
      if (!loadingScreen || !progressBar || !statusText || !mainContent || !loaderContainer || !backgroundAnimation ||
          !screens.mainMenu || !screens.chapterSelect || !screens.levelSelect || !screens.game || !startGameBtn || 
          !settingsBtn || !backToMainBtn || !chapterGrid || !levelSelectTitle || !levelGrid || !backToChaptersBtn ||
          !gameScreen || !timerBarProgress || !questionTitle || !questionText || !answersContainer || !backToMapInGameBtn ||
          !feedbackModal || !modalTitle || !modalMessage || !modalNextBtn || !modalRetryBtn || !modalMapBtn ||
          !nameEntryContainer || !playerNameInput || !continueBtn || !welcomeContainer || !welcomeMessage || !mainMenuButtons || !changeNameBtn
          ) {
        console.error('Essential UI elements not found!');
        return;
      }

      // --- Game State ---
      let loadingInterval = null;
      let timerInterval = null;
      let gameData = [];
      let playerProgress = { chapters: {} };
      let currentLevel = 0;
      let currentChapterId = '';
      let currentQuestion = null;


      // --- Game Data & Progress ---
      function saveProgress() {
        localStorage.setItem('iranRapProgress', JSON.stringify(playerProgress));
      }

      function loadProgress() {
          const savedProgress = localStorage.getItem('iranRapProgress');
          if (savedProgress) {
              const progress = JSON.parse(savedProgress);
              // Backward compatibility: Convert old progress format
              if (progress.unlockedLevel && !progress.chapters) {
                  playerProgress = {
                      playerName: progress.playerName,
                      chapters: {
                          'yas': { completedLevels: progress.unlockedLevel - 1, completedQuestions: [] }
                      }
                  };
                  saveProgress(); // Save in new format
              } else {
                  playerProgress = progress;
              }
              // Ensure chapters object exists for robustness
              if (!playerProgress.chapters) {
                  playerProgress.chapters = {};
              }
          } else {
              // Default for new players
              playerProgress = { chapters: {} };
          }
      }

      // --- Main Menu Setup ---
      function setupMainMenu() {
        if (playerProgress.playerName) {
          welcomeMessage.innerHTML = `خوش آمدی، <span>${playerProgress.playerName}</span>!`;
          nameEntryContainer.classList.add('hidden');
          welcomeContainer.classList.remove('hidden');
          mainMenuButtons.classList.remove('hidden');
        } else {
          nameEntryContainer.classList.remove('hidden');
          welcomeContainer.classList.add('hidden');
          mainMenuButtons.classList.add('hidden');
          playerNameInput.focus();
        }
      }

      function updateChapterSelectScreen() {
          const yasProgress = playerProgress.chapters['yas'] || { completedLevels: 0 };
          const yasChapterCard = document.querySelector('.chapter-card[data-source="yas.json"]');
          const pishroChapterCard = document.querySelector('.chapter-card[data-source="pishro.json"]');
          const pishroSoonText = pishroChapterCard.querySelector('.soon-text');

          if (!yasChapterCard || !pishroChapterCard || !pishroSoonText) return;

          const totalYasLevels = parseInt(yasChapterCard.dataset.totalLevels || '200');

          if (yasProgress.completedLevels >= totalYasLevels) {
              pishroChapterCard.classList.remove('disabled');
              pishroSoonText.classList.add('hidden');
          } else {
              pishroChapterCard.classList.add('disabled');
              pishroSoonText.textContent = `ابتدا فصل ۱ را کامل کنید`;
              pishroSoonText.classList.remove('hidden');
          }
      }

      // --- Screen Navigation ---
      function navigateTo(screenName) {
        clearTimer(); // Always clear timer on navigation
        Object.values(screens).forEach(screen => screen?.classList.remove('is-visible'));
        Object.values(screens).forEach(screen => screen?.classList.add('hidden'));
        
        if (screenName === 'chapterSelect') {
            updateChapterSelectScreen();
        }

        const targetScreen = screens[screenName];
        if (targetScreen) {
          targetScreen.classList.remove('hidden');
          setTimeout(() => targetScreen.classList.add('is-visible'), 10);
        }
      }

      // --- Loading Screen Logic ---
      function startLoading() {
        if (loadingInterval) return;
        statusText.textContent = 'در حال بارگذاری...';
        statusText.classList.remove('error');
        loaderContainer.style.display = 'block';
        progressBar.style.width = '0%';
        
        let progress = 0;
        loadingInterval = setInterval(() => {
          progress += 1;
          progressBar.style.width = `${progress}%`;
          statusText.textContent = `در حال بارگذاری... ${progress}%`;
          if (progress >= 100) {
            if(loadingInterval) clearInterval(loadingInterval);
            loadingInterval = null;
            setTimeout(finishLoading, 500);
          }
        }, 40);
      }

      function finishLoading() {
        loadingScreen.classList.add('fade-out');
        loadingScreen.addEventListener('transitionend', () => {
          mainContent.classList.remove('hidden');
          navigateTo('mainMenu');
        }, { once: true });
      }
      
      async function initializeApp() {
        startLoading();
      }

      // --- Timer Logic ---
      function clearTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      function startTimer() {
        clearTimer();
        let timeLeft = LEVEL_TIME;

        void timerBarProgress.offsetWidth;

        timerBarProgress.style.transition = `width ${LEVEL_TIME}s linear, background 0.5s`;
        timerBarProgress.style.width = '0%';
        
        timerInterval = setInterval(() => {
          timeLeft--;
          if (timeLeft <= 5) {
            timerBarProgress.classList.add('low-time');
          }
          if (timeLeft <= 0) {
            handleTimeUp();
          }
        }, 1000);
      }

      function handleTimeUp() {
        clearTimer();
        answersContainer.querySelectorAll('.answer-button').forEach(btn => btn.classList.add('disabled'));
        showFeedbackModal(false, true); // isCorrect = false, isTimeUp = true
      }

      // --- Game Logic ---
      function populateLevelGrid(chapterTitle, chapterId) {
        levelGrid.innerHTML = '';
        levelSelectTitle.textContent = chapterTitle;
        const chapterProgress = playerProgress.chapters[chapterId] || { completedLevels: 0 };
        const unlockedLevel = chapterProgress.completedLevels + 1;

        for (let i = 1; i <= gameData.length; i++) {
            const levelButton = document.createElement('div');
            levelButton.classList.add('level-button');
            levelButton.dataset.level = i.toString();

            if (i < unlockedLevel) {
                levelButton.classList.add('completed');
                levelButton.textContent = `✔`;
            } else if (i === unlockedLevel) {
                levelButton.classList.add('unlocked');
                levelButton.textContent = i.toString();
            } else {
                levelButton.classList.add('locked');
            }
            levelButton.style.animationDelay = `${0.2 + i * 0.025}s`;
            levelGrid.appendChild(levelButton);
        }
      }

      async function selectChapter(chapterElement) {
        if (chapterElement.classList.contains('disabled')) return;
        const chapterNumber = chapterElement.dataset.chapter;
        const chapterTitle = chapterElement.dataset.title || `فصل ${chapterNumber}`;
        const dataSource = chapterElement.dataset.source;

        if (!dataSource) {
          alert(`فصل ${chapterNumber} به زودی عرضه می‌شود!`);
          return;
        }
        const chapterId = dataSource.replace('.json', '');
        currentChapterId = chapterId;

        mainContent.classList.add('is-loading-chapter');
        
        try {
          const response = await fetch(dataSource);
          if (!response.ok) throw new Error(`Network response was not ok for ${dataSource}`);
          gameData = await response.json();
          
          populateLevelGrid(chapterTitle, chapterId);
          navigateTo('levelSelect');
        } catch (error) {
          console.error(`Failed to load chapter data from ${dataSource}:`, error);
          alert(`خطا در بارگذاری اطلاعات فصل ${chapterNumber}. لطفا اتصال اینترنت خود را بررسی کنید.`);
        } finally {
          mainContent.classList.remove('is-loading-chapter');
        }
      }

      function getNextQuestion(isRetry) {
          const chapterProgress = playerProgress.chapters[currentChapterId];

          // Start with a pool of questions that have not been correctly answered yet.
          let availableQuestions = gameData.filter(q => !chapterProgress.completedQuestions.includes(q.question));

          // If all questions are answered, reset the pool to allow replaying.
          if (availableQuestions.length === 0 && gameData.length > 0) {
              chapterProgress.completedQuestions = []; // Reset for replayability
              saveProgress();
              availableQuestions = [...gameData];
          }

          // On retry, if possible, pick a question different from the last one.
          if (isRetry && currentQuestion && availableQuestions.length > 1) {
              const otherQuestions = availableQuestions.filter(q => q.question !== currentQuestion.question);
              if (otherQuestions.length > 0) {
                  availableQuestions = otherQuestions;
              }
          }
          
          if (availableQuestions.length === 0) return null;
          
          const randomIndex = Math.floor(Math.random() * availableQuestions.length);
          return availableQuestions[randomIndex];
      }

      function startLevel(levelNumber, isRetry = false) {
        // Ensure progress object exists for the current chapter
        if (!playerProgress.chapters[currentChapterId]) {
            playerProgress.chapters[currentChapterId] = { completedLevels: 0, completedQuestions: [] };
        }
        
        if (!isRetry) {
            currentQuestion = null;
        }

        const levelData = getNextQuestion(isRetry);

        if (!levelData) {
            console.error("Could not find a question to display.");
            alert("مرحله‌ای برای نمایش یافت نشد. لطفا به صفحه فصل‌ها بازگردید.");
            navigateTo('chapterSelect');
            return;
        }
        
        currentQuestion = levelData;
        currentLevel = levelNumber;

        timerBarProgress.style.transition = 'none';
        timerBarProgress.style.width = '100%';
        timerBarProgress.classList.remove('low-time');
        
        questionTitle.textContent = `مرحله ${levelNumber}`;
        questionText.textContent = levelData.question;
        answersContainer.innerHTML = '';

        // Shuffle options to randomize their display order
        const shuffledOptions = [...levelData.options];
        for (let i = shuffledOptions.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
        }

        shuffledOptions.forEach(option => {
          const button = document.createElement('button');
          button.classList.add('answer-button');
          button.textContent = option;
          button.onclick = () => handleAnswer(button, option, levelData.answer);
          answersContainer.appendChild(button);
        });
        
        navigateTo('game');
        setTimeout(startTimer, 500);
      }
      
      function handleAnswer(button, selectedAnswer, correctAnswer) {
        clearTimer();
        const allButtons = answersContainer.querySelectorAll('.answer-button');
        allButtons.forEach(btn => btn.classList.add('disabled'));

        if (selectedAnswer === correctAnswer) {
            button.classList.add('correct');
            
            const chapterId = currentChapterId;
            const chapterProgress = playerProgress.chapters[chapterId];

            // Add question to completed list if it's not already there
            if (currentQuestion && !chapterProgress.completedQuestions.includes(currentQuestion.question)) {
                chapterProgress.completedQuestions.push(currentQuestion.question);
            }
            
            // If it was the latest unlocked level, increment progress
            if (currentLevel === chapterProgress.completedLevels + 1) {
                chapterProgress.completedLevels++;
            }
            
            saveProgress();
            showFeedbackModal(true, false);
        } else {
          button.classList.add('incorrect');
          allButtons.forEach(btn => {
            if(btn.textContent === correctAnswer) {
              btn.classList.add('correct');
            }
          });
          showFeedbackModal(false, false);
        }
      }
      
      function showFeedbackModal(isCorrect, isTimeUp) {
        if (isTimeUp) {
          modalTitle.textContent = "وقت تموم شد!";
          modalTitle.className = 'incorrect';
          modalMessage.textContent = "سرعت عمل بیشتری لازم داری!";
          modalRetryBtn.classList.remove('hidden');
          modalNextBtn.classList.add('hidden');
        } else if (isCorrect) {
          modalTitle.textContent = "عالی بود!";
          modalTitle.className = 'correct';
          modalMessage.textContent = "به مرحله بعد راه پیدا کردی.";
          modalRetryBtn.classList.add('hidden');
          modalNextBtn.classList.remove('hidden');
          
          const chapterProgress = playerProgress.chapters[currentChapterId];
          if (currentLevel >= gameData.length || chapterProgress.completedLevels >= gameData.length) {
            modalNextBtn.classList.add('hidden');
            modalMessage.textContent = "تو این فصل رو تموم کردی! آفرین.";
          }
        } else {
          modalTitle.textContent = "اشتباه بود!";
          modalTitle.className = 'incorrect';
          modalMessage.textContent = "دوباره تلاش کن، مطمئنم میتونی.";
          modalRetryBtn.classList.remove('hidden');
          modalNextBtn.classList.add('hidden');
        }
        feedbackModal.classList.remove('hidden');
      }

      function hideFeedbackModal() {
        feedbackModal.classList.add('hidden');
      }

      function handleParallax(event) {
          const { clientX, clientY } = event;
          const { innerWidth, innerHeight } = window;
          const moveX = (clientX - innerWidth / 2) / 40;
          const moveY = (clientY - innerHeight / 2) / 40;
          backgroundAnimation.style.transform = `translate(${moveX}px, ${moveY}px)`;
      }

      // --- Event Listeners ---
      continueBtn.addEventListener('click', () => {
        const name = playerNameInput.value.trim();
        if (name) {
          playerProgress.playerName = name;
          saveProgress();
          setupMainMenu();
        } else {
            playerNameInput.classList.add('shake');
            setTimeout(() => playerNameInput.classList.remove('shake'), 500);
        }
      });
      
      playerNameInput.addEventListener('keypress', (event) => {
        if (event.key === 'Enter') {
          continueBtn.click();
        }
      });

      changeNameBtn.addEventListener('click', () => {
        playerProgress.playerName = '';
        saveProgress();
        setupMainMenu();
      });

      startGameBtn.addEventListener('click', () => navigateTo('chapterSelect'));
      backToMainBtn.addEventListener('click', () => navigateTo('mainMenu'));
      backToChaptersBtn.addEventListener('click', () => navigateTo('chapterSelect'));
      
      backToMapInGameBtn.addEventListener('click', () => {
        loadProgress();
        const chapterTitle = levelSelectTitle.textContent || "انتخاب مرحله";
        populateLevelGrid(chapterTitle, currentChapterId);
        navigateTo('levelSelect');
      });

      
      settingsBtn.addEventListener('click', () => alert('صفحه تنظیمات در دست ساخت است!'));
      
      chapterGrid.addEventListener('click', (event) => {
        const chapterCard = event.target.closest('.chapter-card');
        if (chapterCard) selectChapter(chapterCard);
      });

      levelGrid.addEventListener('click', (event) => {
        const levelButton = event.target.closest('.level-button');
        if (levelButton && !levelButton.classList.contains('locked')) {
            const levelNumber = parseInt(levelButton.dataset.level || '0');
            startLevel(levelNumber, false);
        }
      });

      modalNextBtn.addEventListener('click', () => {
        hideFeedbackModal();
        startLevel(currentLevel + 1, false);
      });

      modalRetryBtn.addEventListener('click', () => {
        hideFeedbackModal();
        startLevel(currentLevel, true);
      });
      
      modalMapBtn.addEventListener('click', () => {
        hideFeedbackModal();
        loadProgress();
        const chapterTitle = levelSelectTitle.textContent || "انتخاب مرحله";
        populateLevelGrid(chapterTitle, currentChapterId);
        navigateTo('levelSelect');
      });
      
      window.addEventListener('mousemove', handleParallax);

      // --- Initialisation ---
      loadProgress();
      setupMainMenu();
      initializeApp();
    });
  </script>

</body>
</html>
